
# 102.3 - مدیریت کتابخانه‌های مشترک (Shared Libraries)

## اهداف یادگیری

در این فصل با موارد زیر آشنا می‌شوید:

- شناسایی کتابخانه‌های مشترک مورد نیاز برنامه‌ها  
- آشنایی با محل‌های معمول ذخیره کتابخانه‌های سیستم  
- بارگذاری کتابخانه‌های مشترک در زمان اجرا  

## کلیدواژه‌ها

`ldd`, `ldconfig`, `/etc/ld.so.conf`, `LD_LIBRARY_PATH`

---

## Linking (لینک کردن)

هنگام نوشتن برنامه‌ها، از کتابخانه‌ها استفاده می‌کنیم. دو روش لینک کردن وجود دارد:

- **Static Linking (لینک ایستا):**  
  کتابخانه‌ها داخل فایل اجرایی قرار می‌گیرند.  
  - مزیت: برنامه بدون وابستگی به کتابخانه‌های خارجی اجرا می‌شود.  
  - عیب: حجم برنامه بزرگ‌تر می‌شود.  

- **Dynamic Linking (لینک پویا):**  
  برنامه فقط اعلام می‌کند که به کتابخانه‌های خاصی نیاز دارد.  
  - مزیت: برنامه کوچک‌تر و امن‌تر است (کتابخانه‌ها به‌صورت مرکزی به‌روزرسانی می‌شوند).  
  - نام دیگر: **Shared Libraries** چون چندین برنامه از یک کتابخانه مشترک استفاده می‌کنند.  

!!! info "نکته"
    در لینوکس کتابخانه‌های پویا معمولاً با نام‌هایی مثل `libNAME.so.VERSION` در مسیرهای `/lib*/` و `/usr/lib*/` قرار دارند. در ویندوز به آن‌ها DLL گفته می‌شود.

---

## محل کتابخانه‌ها

- کتابخانه‌های سیستمی: `/lib`, `/lib64`  
- کتابخانه‌های نرم‌افزارها: `/usr/lib`, `/usr/lib64`  

---

## دستور ldd

دستور `ldd` برای بررسی وابستگی‌های برنامه‌ها استفاده می‌شود:

- تشخیص ایستا یا پویا بودن لینک  
- نمایش کتابخانه‌های مورد نیاز برنامه  

**مثال:**

```bash
ldd /sbin/ldconfig
# not a dynamic executable

ldd /bin/ls
    libselinux.so.1 => /lib64/libselinux.so.1
    libc.so.6 => /lib64/libc.so.6
    ...
```

---

## لینک‌های نمادین (Symbolic Links)

گاهی نسخه‌های مختلف یک کتابخانه با نام‌های متفاوت وجود دارند. برای سازگاری، از لینک‌های نمادین استفاده می‌شود.

**مثال:**

```bash
ls -la /lib/i386-linux-gnu/libudev.so.1
lrwxrwxrwx 1 root root 16 Nov 13 23:05 libudev.so.1 -> libudev.so.1.4.0
```

!!! tip "نکته"
    حتی اگر برنامه‌ای به `libudev.so.1` نیاز داشته باشد، سیستم نسخه نصب‌شده (`libudev.so.1.4.0`) را استفاده می‌کند.

---

## پیکربندی و کش کتابخانه‌ها

- فایل پیکربندی: `/etc/ld.so.conf`  
- در اوبونتو: شامل فایل‌های `/etc/ld.so.conf.d/`  

**مثال:**

```bash
cat /etc/ld.so.conf
include ld.so.conf.d/*.conf
```

### دستور ldconfig

- پردازش فایل‌های پیکربندی  
- ایجاد کش (`ld.so.cache`) برای دسترسی سریع‌تر به کتابخانه‌ها  

**مشاهده کش:**

```bash
ldconfig -p | head
```

!!! warning "هشدار"
    پس از تغییر فایل‌های پیکربندی باید `ldconfig` اجرا شود تا کش به‌روزرسانی شود.

---

## مسیر جستجوی کتابخانه‌ها

ترتیب جستجو:

1. متغیر محیطی `LD_LIBRARY_PATH`  
2. مسیر برنامه  
3. فایل `/etc/ld.so.conf` و زیرشاخه‌های آن  
4. مسیرهای پیش‌فرض: `/lib`, `/lib64`, `/usr/lib`, `/usr/lib64`  

**مثال استفاده از LD_LIBRARY_PATH:**

```bash
export LD_LIBRARY_PATH=/usr/lib/myoldlibs:/home/user/libs/
```

!!! info "کاربرد"
    این روش برای تست نسخه‌های قدیمی یا توسعه کتابخانه‌ها بدون نصب دائمی استفاده می‌شود.

---

## بارگذاری پویا (Dynamic Loading)

برنامه‌ها توسط **Dynamic Loader** اجرا می‌شوند (معمولاً `ld-linux`).  

**یافتن Loader:**

```bash
locate ld-linux
/usr/lib64/ld-linux-x86-64.so.2
```

**اجرای برنامه با Loader:**

```bash
/usr/lib64/ld-linux-x86-64.so.2 /usr/bin/ls
```

!!! tip "ترفند"
    حتی اگر فایل اجرایی بیت اجرا (`x`) نداشته باشد، می‌توانید آن را با `ld-linux` اجرا کنید!

---

## تمرین‌های عملی

### تمرین 1: بررسی وابستگی‌ها
```bash
ldd /bin/ls
```

### تمرین 2: مشاهده کش کتابخانه‌ها
```bash
ldconfig -p | less
```

### تمرین 3: تغییر مسیر کتابخانه‌ها
```bash
export LD_LIBRARY_PATH=/home/user/libs
./myprogram
```

### تمرین 4: اجرای برنامه با Loader
```bash
/usr/lib64/ld-linux-x86-64.so.2 ./myprogram
```

---

## خلاصه

در این فصل یاد گرفتیم:

- تفاوت لینک ایستا و پویا  
- محل ذخیره کتابخانه‌های سیستمی و نرم‌افزاری  
- استفاده از دستور `ldd` برای بررسی وابستگی‌ها  
- نقش لینک‌های نمادین در سازگاری نسخه‌ها  
- پیکربندی و کش کتابخانه‌ها با `ld.so.conf` و `ldconfig`  
- ترتیب جستجوی کتابخانه‌ها در سیستم  
- استفاده از `LD_LIBRARY_PATH` برای override کتابخانه‌ها  
- اجرای برنامه‌ها با Dynamic Loader (`ld-linux`)  

!!! example "نکات کلیدی برای آزمون"
    - تفاوت Static و Dynamic Linking  
    - مسیرهای `/lib`, `/usr/lib` برای کتابخانه‌ها  
    - دستورهای `ldd` و `ldconfig`  
    - نقش `LD_LIBRARY_PATH`  
    - مفهوم Symbolic Links برای کتابخانه‌ها  
